/**
* Statesman - State management made straightforward
*
* v0.1.2 - 2013-01-14
*
* https://github.com/Rich-Harris/Statesman.git
*
* Copyright (c) 2013 Rich Harris
* Licensed MIT
*/
(function(e){"use strict";var t,n,r,i,s,o,u,a,f=/^[0-9]+$/,l=/\[([0-9]+)\]/;t=function(e){this._data=e||{},this._observers={},this._computed={},this._subsets={},this._queue=[]},t.prototype={set:function(e,t,n){var s,o,a,l,c,h;if(typeof e=="object"){this._queueing=!0,n=t;for(s in e)e.hasOwnProperty(s)&&this.set(s,e[s],n);return r(this._queue),this._queueing=!1,this}n=n||{},h=this._computed[e];if(h)if(!this._computing){if(h.readonly)throw'The computed value "'+e+'" has readonly set true and cannot be changed manually';h.override=!0}else h.override=!1,this._computing=!1;this._referToCache=!0,c=this.get(e),this._referToCache=!1,o=i(e),e=o.join("."),l=this._data;while(o.length>1)a=o.shift(),l[a]||(o[0]===parseInt(o[0],10)||f.test(o[0])?l[a]=[]:l[a]={}),l=l[a];return a=o[0],l[a]=t,!n.silent&&(n.force||!u(c,t))&&this._notifyObservers(e,t,n.force),this},get:function(e){var t,n,r;if(!e)return this._data;this._referToCache||(r=this._computed[e],r&&!r.cache&&!r.override&&r.setter()),t=i(e),n=this._data;while(t.length){try{n=n[t.shift()]}catch(s){return undefined}if(n===undefined)return undefined}return n},observe:function(e,t,n){var r=this,i,s=[],u,a;if(!e)return undefined;if(typeof e=="object"){n=t;for(a in e)e.hasOwnProperty(a)&&(s[s.length]=this.observe(a,e[a],n));return s}i=e=o(e),u=function(e){var n,o;n=r._observers[e]=r._observers[e]||[],o={observedKeypath:e,originalKeypath:i,callback:t,group:s},n[n.length]=o,s[s.length]=o};while(e.lastIndexOf(".")!==-1)u(e),e=e.substr(0,e.lastIndexOf("."));return u(e),n&&t(this.get(i)),s.__previousValue=r.get(i),s},observeOnce:function(e,t){var n=this,r;return r=this.observe(e,function(e,i){t(e,i),n.unobserve(r)}),r},unobserve:function(e){var t,n,r;if(e.hasOwnProperty("length")){while(e.length)this.unobserve(e.shift());return}r=o(e.observedKeypath),t=this._observers[r];if(!t)return;n=t.indexOf(e);if(n===-1)return;return t.splice(n,1),t.length===0&&delete this._observers[r],this},compute:function(e,t){var n=this,r,i,s,o,u,f,l,c,h,p,d;if(typeof e=="object"){d={};for(r in e)e.hasOwnProperty(r)&&(d[r]=this.compute(r,e[r]));return d}this._computed[e]&&this.removeComputedValue(e),u=t.fn,o=t.triggers||t.trigger,f=t.context||this,o?typeof o=="string"&&(o=[o]):o=[];if(a(e,o)!==-1)throw"A computed value cannot be its own trigger";o.length?l=t.cache===!1?!1:!0:l=!1,c=t.readonly===!1?!1:!0,p=[],i=function(){var e,r=[];e=o.length;while(e--)r[e]=n.get(o[e]);return h=t.fn.apply(f,r),h},s=function(){d.cache=!0,n._computing=!0,n.set(e,i()),d.cache=l},d=this._computed[e]={getter:i,setter:s,cache:l||!1,readonly:c,observerGroups:p},s(),r=o.length;if(!r&&l)throw"Cached computed values must have at least one trigger";while(r--)p[p.length]=this.observe(o[r],s);return h},removeComputedValue:function(e){var t=this._computed[e].observerGroups;while(t.length)this.unobserve(t.pop());return delete this._computed[e],this},subset:function(e){if(!e)throw"No subset path specified";return this._subsets[e]||(this._subsets[e]=new n(e,this)),this._subsets[e]},_notifyObservers:function(e,t,n){var r=this,i=this._observers[e]||[],s,o,a,f;for(s=0;s<i.length;s+=1){o=i[s],f=o.group.__previousValue,e!==o.originalKeypath?a=r.get(o.originalKeypath):a=t,o.group.__previousValue=a;if(!n&&u(a,f))continue;this._queueing?this._addToQueue(o.callback,a,f):o.callback(a,f)}while(e.lastIndexOf(".")!==-1){e=e.substr(0,e.lastIndexOf(".")),i=this._observers[e];if(!i)continue;s=i.length;while(s--)o=i[s],o.observedKeypath===o.originalKeypath&&(t=this.get(e),this._queueing?this._addToQueue(o.callback,t,t):o.callback(t,t))}},_addToQueue:function(e,t,n){var r;for(r=0;r<this._queue.length;r+=1)if(this._queue[r].c===e){this._queue.splice(r,1);break}this._queue[this._queue.length]={c:e,v:t,p:n}}},r=function(e){var t;while(e.length)t=e.shift(),t.c(t.v,t.p)},i=function(e){var t,n=[],r;t=e.split(".");for(r=0;r<t.length;r+=1)n=n.concat(s(t[r]));return n},s=function(e){var t,n,r,i;t=e.indexOf("[");if(t===-1)return e;i=[e.substr(0,t)],n=e.substring(t);while(n.length){r=l.exec(n);if(!r)return i;i[i.length]=+r[1],n=n.substring(r[0].length)}return i},o=function(e){return i(e).join(".")},u=function(e,t){return e===null&&t===null?!0:typeof e=="object"||typeof t=="object"?!1:e===t},a=function(e,t){var n;if(t.indexOf)return t.indexOf(e);for(n=0;n<t.length;n+=1)if(t[n]===e)return n;return-1},n=function(e,t){this._path=e,this._pathDot=e+".",this._root=t},n.prototype={set:function(e){var t,n,r;t=Array.prototype.slice.call(arguments);if(typeof e=="object"){r={};for(n in e)r[this._pathDot+n]=e[n];t[0]=r}else t[0]=this._pathDot+e;return this._root.set.apply(this._root,t),this},get:function(e){return e?this._root.get(this._pathDot+e):this._root.get(this._path)},observe:function(e){var t,n,r;t=Array.prototype.slice.call(arguments);if(typeof e=="object"){r={};for(n in e)r[this._pathDot+n]=e[n];t[0]=r}else t[0]=this._pathDot+e;return this._root.observe.apply(this._root,t)},observeOnce:function(e,t){return this._root.observeOnce(this._pathDot+e,t)},unobserve:function(e){return this._root.unobserve(e),this},compute:function(e,t){var n=this,r,i,s,o,u;u=this._pathDot,s=function(e){var t,r;t=e.triggers||e.trigger,typeof t=="string"&&(t=[t]),t&&(delete e.triggers,delete e.trigger),r=t.length;while(r--)t[r]=u+t[r];return e.triggers=t,e.context||(e.context=n),e};if(typeof e=="object"){i={};for(r in e)i[this._pathDot+r]=s(e[r]);return this._root.compute(i)}return this._root.compute(this._pathDot+e,s(t))},removeComputedValue:function(e){return this._root.removeComputedValue(this._pathDot+e),this},subset:function(e){return this._root.subset(this._pathDot+e)}},typeof module!="undefined"&&module.exports?module.exports=t:typeof define=="function"&&define.amd?define(function(){return t}):e.Statesman=t})(this);