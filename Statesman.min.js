(function(t){"use strict";var e,r,o,i,n,s,h,u=/^[0-9]+$/,c=/\[([0-9]+)\]/;e=function(t){this._data=t||{},this._observers={},this._computed={},this._subsets={},this._queue=[]},e.prototype={set:function(t,e,r){var i,n,h,c,a,f;if("object"==typeof t){this._queueing=!0,r=e;for(i in t)t.hasOwnProperty(i)&&this.set(i,t[i],r);return this._dispatchQueue(),this._queueing=!1,this}if(r=r||{},f=this._computed[t])if(this._computing)f.override=!1,this._computing=!1;else{if(f.readonly)throw'The computed value "'+t+'" has readonly set true and cannot be changed manually';f.override=!0}for(this._referToCache=!0,a=this.get(t),this._referToCache=!1,n=o(t),t=n.join("."),c=this._data;n.length>1;)h=n.shift(),c[h]||(c[h]=n[0]===parseInt(n[0],10)||u.test(n[0])?[]:{}),c=c[h];return h=n[0],c[h]=e,r.silent||!r.force&&s(a,e)||this._notifyObservers(t,e,r.force),this},get:function(t){var e,r,i;if(!t)return this._data;for(this._referToCache||(i=this._computed[t],!i||i.cache||i.override||i.setter()),e=o(t),r=this._data;e.length;){try{r=r[e.shift()]}catch(n){return void 0}if(void 0===r)return void 0}return r},observe:function(t,e,r){var o,i,s,h=this,u=[];if("function"==typeof t&&(r=e,e=t,t=""),"object"==typeof t){r=e;for(s in t)t.hasOwnProperty(s)&&(u[u.length]=this.observe(s,t[s],r));return u}if(r||(r={}),"string"!=typeof t||"function"!=typeof e||"object"!=typeof r)throw"Invalid arguments to observe()";for(o=t=n(t),i=function(t){var i,n;i=h._observers[t]=h._observers[t]||[],n={observedKeypath:t,originalKeypath:o,callback:e,group:u,context:r.context||h},i[i.length]=n,u[u.length]=n};-1!==t.lastIndexOf(".");)i(t),t=t.substr(0,t.lastIndexOf("."));return i(t),(!r.hasOwnProperty("init")||r.init)&&e.call(r.context||this,this.get(o)),u.__previousValue=h.get(o),u},observeOnce:function(t,e,r){var o,i=this;return r||(r={}),r.init=!1,o=this.observe(t,function(t,r){e.call(this,t,r),i.unobserve(o)},r)},unobserve:function(t){var e,r,o;if(t.hasOwnProperty("length"))for(;t.length;)this.unobserve(t.shift());else if(o=n(t.observedKeypath),e=this._observers[o],e&&(r=e.indexOf(t),-1!==r))return e.splice(r,1),0===e.length&&delete this._observers[o],this},compute:function(t,e){var r,o,i,n,s,u,c,a,f,p,l,_=this;if("object"==typeof t){l={};for(r in t)t.hasOwnProperty(r)&&(l[r]=this.compute(r,t[r]));return l}if(this._computed[t]&&this.removeComputedValue(t),s=e.fn,n=e.triggers||e.trigger,u=e.context||this,n?"string"==typeof n&&(n=[n]):n=[],-1!==h(t,n))throw"A computed value cannot be its own trigger";if(c=n.length?e.cache===!1?!1:!0:!1,a=e.readonly===!1?!1:!0,p=[],o=function(){var t,r=[];for(t=n.length;t--;)r[t]=_.get(n[t]);return f=e.fn.apply(u,r)},i=function(){l.cache=!0,_._computing=!0,_.set(t,o()),l.cache=c},l=this._computed[t]={getter:o,setter:i,cache:c||!1,readonly:a,observerGroups:p},i(),r=n.length,!r&&c)throw"Cached computed values must have at least one trigger";for(;r--;)p[p.length]=this.observe(n[r],i,{init:!1,context:u});return f},removeComputedValue:function(t){for(var e=this._computed[t].observerGroups;e.length;)this.unobserve(e.pop());return delete this._computed[t],this},subset:function(t){if(!t)throw"No subset path specified";return this._subsets[t]||(this._subsets[t]=new r(t,this)),this._subsets[t]},_notifyObservers:function(t,e,r){var o,i,n,h,u,c=this,a=this._observers[t]||[];for(o=0;a.length>o;o+=1)i=a[o],h=i.group.__previousValue,n=t!==i.originalKeypath?c.get(i.originalKeypath):e,i.group.__previousValue=n,(r||!s(n,h))&&(this._queueing?this._addToQueue(i.callback,n,h,i.context||this):i.callback.call(i.context||this,n,h));for(u=function(t){var r,o=c._observers[t];if(o)for(r=o.length;r--;)i=o[r],i.observedKeypath===i.originalKeypath&&(e=c.get(t),c._queueing?c._addToQueue(i.callback,e,e):i.callback.call(i.context||this,e,e))};-1!==t.lastIndexOf(".");)t=t.substr(0,t.lastIndexOf(".")),u(t);u("")},_addToQueue:function(t,e,r,o){var i;for(i=0;this._queue.length>i;i+=1)if(this._queue[i].c===t){this._queue.splice(i,1);break}this._queue[this._queue.length]={c:t,v:e,p:r,cx:o}},_dispatchQueue:function(){for(var t;this._queue.length;)t=this._queue.shift(),t.c.call(t.cx,t.v,t.p)}},o=function(t){var e,r,o=[];for(e=t.split("."),r=0;e.length>r;r+=1)o=o.concat(i(e[r]));return o},i=function(t){var e,r,o,i;if(e=t.indexOf("["),-1===e)return t;for(i=[t.substr(0,e)],r=t.substring(e);r.length;){if(o=c.exec(r),!o)return i;i[i.length]=+o[1],r=r.substring(o[0].length)}return i},n=function(t){return o(t).join(".")},s=function(t,e){return null===t&&null===e?!0:"object"==typeof t||"object"==typeof e?!1:t===e},h=function(t,e){var r;if(e.indexOf)return e.indexOf(t);for(r=0;e.length>r;r+=1)if(e[r]===t)return r;return-1},r=function(t,e){this._path=t,this._pathDot=t+".",this._root=e},r.prototype={set:function(t){var e;return e=Array.prototype.slice.call(arguments),"object"==typeof t?e.unshift(this._path):e[0]=this._pathDot+t,this._root.set.apply(this._root,e),this},get:function(t){return t?this._root.get(this._pathDot+t):this._root.get(this._path)},observe:function(t,e,r){var o,i,n;if(o=Array.prototype.slice.call(arguments),"object"==typeof t){r=e,n={};for(i in t)n[this._pathDot+i]=t[i];return r?r.context=r.context||this:r={context:this},this._root.observe(n,r)}return"function"==typeof t?(r=e,e=t,t=this._path):t=""===t?this._path:this._pathDot+t,r?r.context=r.context||this:r={context:this},this._root.observe(t,e,r)},observeOnce:function(t,e,r){r?r.context=r.context||this:r={context:this};var o=this._root.observeOnce(this._pathDot+t,e,r);return o},unobserve:function(t){return this._root.unobserve(t),this},compute:function(t,e){var r,o,i,n,s=this;if(n=this._pathDot,e.context=e.context||this,i=function(t){var e,r;for(e=t.triggers||t.trigger,"string"==typeof e&&(e=[e]),e&&(delete t.triggers,delete t.trigger),r=e.length;r--;)e[r]=n+e[r];return t.triggers=e,t.context||(t.context=s),t},"object"==typeof t){o={};for(r in t)o[this._pathDot+r]=i(t[r]);return this._root.compute(o)}return this._root.compute(this._pathDot+t,i(e))},removeComputedValue:function(t){return this._root.removeComputedValue(this._pathDot+t),this},subset:function(t){return this._root.subset(this._pathDot+t)}},"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):t.Statesman=e})(this);