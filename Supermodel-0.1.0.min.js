/**
* Supermodel - Keep track of your application state in style
*
* v0.1.0 - 2012-11-29
*
* https://github.com/Rich-Harris/Supermodel.git
*
* Copyright (c) 2012 Rich Harris
* Licensed MIT
*/
(function(e){"use strict";var t,n,r,i,s,o=/^[0-9]+$/,u=/\[([0-9]+)\]/;t=function(e){this._data=e||{},this._observers={}},t.prototype={set:function(e,t,r,i){var u,a,f,l,c,h,p;if(typeof e=="object"){r=t;for(u in e)e.hasOwnProperty(u)&&this.set(u,e[u],r);return}p=this.get(e),a=n(e),e=a.join("."),l=this._data;while(a.length>1)f=a.shift(),l[f]||(a[0]===parseInt(a[0],10)||o.test(a[0])?l[f]=[]:l[f]={}),l=l[f];return f=a[0],l[f]=t,!r&&(i||!s(p,t))&&this._notifyObservers(e,t,p,i),this},get:function(e){var t,r;if(!e)return undefined;t=n(e),r=this._data;while(t.length){try{r=r[t.shift()]}catch(i){return undefined}if(r===undefined)return undefined}return r},observe:function(e,t,n){var r=this,s,o=[],u;if(!e)return undefined;s=e=i(e),u=function(e){var n,i;n=r._observers[e]=r._observers[e]||[],i={observedKeypath:e,originalKeypath:s,callback:t,previousValue:r.get(s)},n[n.length]=i,o[o.length]=i};while(e.lastIndexOf(".")!==-1)u(e),e=e.substr(0,e.lastIndexOf("."));return u(e),n&&t(this.get(e)),o},observeOnce:function(e,t){var n=this,r;return r=this.observe(e,function(e,i){t(e,i),n.unobserve(r)}),this},unobserve:function(e){var t,n,r;if(e.hasOwnProperty("length")){while(e.length)this.unobserve(e.shift());return}r=i(e.observedKeypath),t=this._observers[r];if(!t)return;n=t.indexOf(e);if(n===-1)return;return t.splice(n,1),t.length===0&&delete this._observers[r],this},_notifyObservers:function(e,t,n,r){var i=this,o=this._observers[e]||[],u,a;for(u=0;u<o.length;u+=1){a=o[u];if(e!==a.originalKeypath){n=a.previousValue,t=i.get(a.originalKeypath);if(!r&&s(t,n))continue;a.previousValue=t}a.callback(t,n)}}},n=function(e){var t,n=[],i,s,o,u,a,f;t=e.split(".");for(o=0;o<t.length;o+=1)n=n.concat(r(t[o]));return n},r=function(e){var t,n,r,i;t=e.indexOf("[");if(t===-1)return e;i=[e.substr(0,t)],n=e.substring(t);while(n.length){r=u.exec(n);if(!r)return i;i[i.length]=+r[1],n=n.substring(r[0].length)}return i},i=function(e){return n(e).join(".")},s=function(e,t){return e===null&&t===null?!0:typeof e=="object"||typeof t=="object"?!1:e===t},typeof module!="undefined"&&module.exports?module.exports=t:typeof define=="function"&&define.amd?define(function(){return t}):e.Supermodel=t})(this);