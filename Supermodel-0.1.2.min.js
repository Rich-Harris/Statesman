/**
* Supermodel - State management made sexy
*
* v0.1.2 - 2013-01-03
*
* https://github.com/Rich-Harris/Supermodel.git
*
* Copyright (c) 2013 Rich Harris
* Licensed MIT
*/
(function(e){"use strict";var t,n,r,i,s,o,u,a=/^[0-9]+$/,f=/\[([0-9]+)\]/;t=function(e){this._data=e||{},this._observers={},this._computed={},this._queue=[]},t.prototype={set:function(e,t,i,s){var u,f,l,c,h,p;if(typeof e=="object"){this.queueing=!0,i=t;for(u in e)e.hasOwnProperty(u)&&this.set(u,e[u],i);return n(this._queue),this.queueing=!1,this}p=this._computed[e];if(p)if(!this.computing){if(p.readonly)throw'The computed value "'+e+'" has readonly set true and cannot be changed manually';p.override=!0}else p.override=!1,this.computing=!1;this._referToCache=!0,h=this.get(e),this._referToCache=!1,f=r(e),e=f.join("."),c=this._data;while(f.length>1)l=f.shift(),c[l]||(f[0]===parseInt(f[0],10)||a.test(f[0])?c[l]=[]:c[l]={}),c=c[l];return l=f[0],c[l]=t,!i&&(s||!o(h,t))&&this._notifyObservers(e,t,s),this},get:function(e){var t,n,i;if(!e)return undefined;this._referToCache||(i=this._computed[e],i&&!i.cache&&!i.override&&i.setter()),t=r(e),n=this._data;while(t.length){try{n=n[t.shift()]}catch(s){return undefined}if(n===undefined)return undefined}return n},observe:function(e,t,n){var r=this,i,o=[],u;if(!e)return undefined;i=e=s(e),u=function(e){var n,s;n=r._observers[e]=r._observers[e]||[],s={observedKeypath:e,originalKeypath:i,callback:t,group:o},n[n.length]=s,o[o.length]=s};while(e.lastIndexOf(".")!==-1)u(e),e=e.substr(0,e.lastIndexOf("."));return u(e),n&&t(this.get(i)),o.__previousValue=r.get(i),o},observeOnce:function(e,t){var n=this,r;return r=this.observe(e,function(e,i){t(e,i),n.unobserve(r)}),this},unobserve:function(e){var t,n,r;if(e.hasOwnProperty("length")){while(e.length)this.unobserve(e.shift());return}r=s(e.observedKeypath),t=this._observers[r];if(!t)return;n=t.indexOf(e);if(n===-1)return;return t.splice(n,1),t.length===0&&delete this._observers[r],this},compute:function(e,t){var n=this,r,i,s,o,a,f,l,c,h,p;if(typeof e=="object"){p={};for(r in e)e.hasOwnProperty(r)&&(p[r]=this.compute(r,e[r]));return p}this._computed[e]&&this.removeComputedValue(e),a=t.fn,o=t.triggers||t.trigger,o||(o=[]),typeof o=="string"&&(o=[o]);if(u(e,o)!==-1)throw"A computed value cannot be its own trigger";o.length?f=t.cache===!1?!1:!0:f=!1,l=t.readonly===!1?!1:!0,h=[],i=function(){var e,r=[];e=o.length;while(e--)r[e]=n.get(o[e]);return c=t.fn.apply(n,r),c},s=function(){p.cache=!0,n.computing=!0,n.set(e,i()),p.cache=f},p=this._computed[e]={getter:i,setter:s,cache:f||!1,readonly:l,observerGroups:h},s(),r=o.length;if(!r&&f)throw"Cached computed values must have at least one trigger";while(r--)h[h.length]=this.observe(o[r],s);return c},removeComputedValue:function(e){var t=this._computed[e].observerGroups;while(t.length)this.unobserve(t.pop());delete this._computed[e]},_notifyObservers:function(e,t,n){var r=this,i=this._observers[e]||[],s,u,a,f;for(s=0;s<i.length;s+=1){u=i[s],f=u.group.__previousValue,e!==u.originalKeypath?a=r.get(u.originalKeypath):a=t,u.group.__previousValue=a;if(!n&&o(a,f))continue;this.queueing?this._addToQueue(u.callback,a,f):u.callback(a,f)}while(e.lastIndexOf(".")!==-1){e=e.substr(0,e.lastIndexOf(".")),i=this._observers[e];if(!i)continue;s=i.length;while(s--)u=i[s],u.observedKeypath===u.originalKeypath&&(t=this.get(e),this.queueing?this._addToQueue(u.callback,t,t):u.callback(t,t))}},_addToQueue:function(e,t,n){var r;for(r=0;r<this._queue.length;r+=1)if(this._queue[r].c===e){this._queue.splice(r,1);break}this._queue[this._queue.length]={c:e,v:t,p:n}}},n=function(e){var t;while(e.length)t=e.shift(),t.c(t.v,t.p)},r=function(e){var t,n=[],r;t=e.split(".");for(r=0;r<t.length;r+=1)n=n.concat(i(t[r]));return n},i=function(e){var t,n,r,i;t=e.indexOf("[");if(t===-1)return e;i=[e.substr(0,t)],n=e.substring(t);while(n.length){r=f.exec(n);if(!r)return i;i[i.length]=+r[1],n=n.substring(r[0].length)}return i},s=function(e){return r(e).join(".")},o=function(e,t){return e===null&&t===null?!0:typeof e=="object"||typeof t=="object"?!1:e===t},u=function(e,t){var n;if(t.indexOf)return t.indexOf(e);for(n=0;n<t.length;n+=1)if(t[n]===e)return n;return-1},typeof module!="undefined"&&module.exports?module.exports=t:typeof define=="function"&&define.amd?define(function(){return t}):e.Supermodel=t})(this);