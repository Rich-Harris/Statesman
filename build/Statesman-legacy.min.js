(function(t){"use strict";var e,n,s,i,r,o,h,a,u,c,f,p,l,d,g,v,y,m,b,w,O={},x={},j={};try{Object.defineProperty({},"test",{value:0}),Object.defineProperties({},{test:{value:0}}),b=Object.defineProperty,w=Object.defineProperties}catch(P){b=function(t,e,n){t[e]=n.value},w=function(t,e){var n;for(n in e)e.hasOwnProperty(n)&&b(t,n,e[n])}}(function(){Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){var n;for(void 0===e&&(e=0),0>e&&(e+=this.length),0>e&&(e=0),n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1})})(),function(){var t=/\$\{\s*([a-zA-Z0-9_$\[\]\.]+)\s*\}/g;i=function(n,s,i){var r,o,h,a;return i=i||"",r=[],o=n.replace(t,function(t,e){return-1===r.indexOf(e)&&(r[r.length]=i+e),'m.get("'+e+'")'}),h=Function("utils","var m=this;try{return "+o+"}catch(e){return undefined}"),a=h.bind?h.bind(s,e.utils):function(){return h.call(s,e.utils)},{getter:a,triggers:r}}}(),e=function(t){w(this,{data:{value:t||{},writable:!0},subs:{value:{},writable:!0},cache:{value:{}},cacheMap:{value:{}},deps:{value:{}},depsMap:{value:{}},refs:{value:{}},refsMap:{value:{}},computed:{value:{}},subsets:{value:{}},deferred:{value:[]},changes:{value:null,writable:!0},upstreamChanges:{value:null,writable:!0},changeHash:{value:null,writable:!0}})},O.add=function(t,e){var n=this.get(t);void 0===e&&(e=1),h(n)&&h(e)&&this.set(t,+n+(void 0===e?1:+e))},function(t){var e,n,s,r;t.compute=function(t,n){var s,i,r;if("object"==typeof t){s={};for(i in t)t.hasOwnProperty(i)&&(r=new e(this,i,t[i]),s[i]=r.value);return s}return r=new e(this,t,n),r.value},e=function(t,e,r){var o;if(t.computed[e]&&t.computed[e].teardown(),this.statesman=t,this.keypath=e,t.computed[e]=this,"string"==typeof r?r=i(r,t):("function"==typeof r&&(r=r()),s(e,r,t.debug)),this.signature=r,this.cache=r.cache,this.refs=[],o=r.dependsOn.length,this.cache)for(1===o&&(this.selfUpdating=!0);o--;)this.refs[o]=new n(this,r.dependsOn[o]);this.setting=!0,t.set(this.keypath,this.value=this.getter()),this.setting=!1},e.prototype={bubble:function(){this.selfUpdating?this.update():this.deferred||(this.statesman.deferred.push(this),this.deferred=!0)},update:function(){var t;return t=this.getter(),o(t,this.value)||(this.setting=!0,c(this.statesman,this.keypath,t),this.setting=!1,this.value=t),this},getter:function(){var t,e,n;try{if(this.signature.compiled)n=this.signature.compiled();else if(e=[],this.cache){for(t=this.refs.length;t--;)e[t]=this.refs[t].value;n=this.signature.get.apply(this.context,e)}else{for(t=this.signature.dependsOn.length;t--;)e[t]=this.statesman.get(this.signature.dependsOn[t]);n=this.signature.get.apply(this.context,e)}}catch(s){if(this.statesman.debug)throw s;n=void 0}return this.override=!1,n},setter:function(t){if(this.signature.set)try{this.signature.set.call(this.context,t)}catch(e){if(this.statesman.debug)throw e}else if(this.signature.readonly){if(this.statesman.debug)throw Error('You cannot overwrite a computed value ("'+this.keypath+'"), unless its readonly flag is set true')}else this.override=!0,this.setting=!0,this.statesman.set(this.keypath,t),this.setting=!1},teardown:function(){for(;this.refs.length;)this.refs.pop().teardown(),this.statesman.computed[this.keypath]=null}},n=function(t,e){this.computed=t,this.statesman=t.statesman,this.keypath=e,this.value=this.statesman.get(e),y(this,!0)},n.prototype={update:function(){var t;t=this.statesman.get(this.keypath),o(t,this.value)||(this.value=t,this.computed.bubble())},teardown:function(){m(this,!0)}},r=[],s=function(t,e,n){if(!e.compiled){if(!e.get&&!e.set)throw Error("Computed values must have either a get() or a set() method, or both");if(e.set||e.readonly===!1||(e.readonly=!0),e.dependsOn?"string"==typeof e.dependsOn&&(e.dependsOn=[e.dependsOn]):e.dependsOn=r,!e.dependsOn.length){if(e.cache&&n)throw Error("Computed values with no dependencies must be uncached");e.cache=!1}e.cache!==!1&&(e.cache=!0)}if(-1!==e.dependsOn.indexOf(t))throw Error('A computed value ("'+t+'") cannot depend on itself');return e}}(O),O.get=function(t){return f(this,t&&a(t))};var f=function(t,e,n,s){var i,r,o,h,a;return e?((i=t.computed[e])&&(s||i.cache||i.override||(t.cache[e]=i.getter())),t.cache.hasOwnProperty(e)?t.cache[e]:(n=n||e.split("."),r=n.pop(),o=n.join("."),h=f(t,o,n),"object"==typeof h&&h.hasOwnProperty(r)&&(a=h[r],t.cache[e]=a,t.cacheMap[o]||(t.cacheMap[o]=[]),t.cacheMap[o].push(e)),a)):t.data};(function(t){var e;t.observe=function(t,n,s){var i,r,o,h,a;if(a=!s||s.init!==!1,"function"==typeof t&&(s=n,n=t,t=""),"string"==typeof t)return i=new e(this,t,n,s),a?i.update():i.value=this.get(t),{cancel:function(){i.teardown()}};if("object"!=typeof t)throw Error("Bad arguments to Statesman.prototype.observe()");s=n,r=[];for(o in t)t.hasOwnProperty(o)&&(r[r.length]=new e(this,o,t[o],s));if(h=r.length,a)for(;h--;)r[h].update();else for(;h--;)r[h].value=this.get(i.keypath);return{cancel:function(){for(h=r.length;h--;)r[h].teardown()}}},e=function(t,e,n,s){this.statesman=t,this.keypath=a(e),this.callback=n,this.context=s&&s.context?s.context:t,y(this)},e.prototype={update:function(){var t;if(t=f(this.statesman,this.keypath),!o(t,this.value)){try{this.callback.call(this.context,t,this.value)}catch(e){if(this.statesman.debug)throw e}this.value=t}},teardown:function(){m(this)}}})(O),O.removeComputedValue=function(t){return this.computed[t]&&this.computed[t].teardown(),this},O.reset=function(t){return this.data={},this.set(t,{silent:!0}),this.fire("reset"),l(this,""),this},function(t){var e,n,s=/^\s*[0-9]+\s*$/;t.set=function(t,e,s){var i,r,o,h;if(this.changes=[],this.upstreamChanges=[],this.changeHash={},"object"==typeof t){s=e;for(o in t)t.hasOwnProperty(o)&&(h=a(o),e=t[o],c(this,h,e))}else h=a(t),c(this,h,e);for(i=[],r=[];this.changes.length;)n(i,this.changes),n(r,this.upstreamChanges),g(this);return s&&s.silent?this:(d(this,r,!0),i.length&&d(this,i),i.length&&this.fire("change",this.changeHash),this)},c=function(t,n,s){var i,r,o;if((o=t.computed[n])&&!o.setting)return o.setter(s),void 0;if(i=f(t,n,null,!0),i!==s)e(t.data,n,s);else if("object"!=typeof s)return;for(p(t,n),t.changes[t.changes.length]=n,t.changeHash[n]=s,r=n.split(".");r.length&&(r.pop(),n=r.join("."),!t.upstreamChanges[n]);)t.upstreamChanges[n]=!0,t.upstreamChanges.push(n)},e=function(t,e,n){for(var i,r=e.split(".");r.length>1;)i=r.shift(),t[i]||(t[i]=s.test(r[0])?[]:{}),t=t[i];t[r[0]]=n},n=function(t,e){for(var n,s=e.length;s--;)n=e[s],t["_"+n]||(t["_"+n]=!0,t[t.length]=n)}}(O),O.subset=function(t){if(!t)throw"No subset path specified";return this.subsets[t]||(this.subsets[t]=new n(t,this)),this.subsets[t]},O.subtract=function(t,e){var n=this.get(t);void 0===e&&(e=1),h(n)&&h(e)&&this.set(t,+n-(void 0===e?1:+e))},O.toggle=function(t){this.set(t,!this.get(t))},p=function(t,e){var n=t.cacheMap[e];if(delete t.cache[e],n)for(;n.length;)p(t,n.pop())},h=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},l=function(t,e,n){var s,i,r;if(s=t.deps[e])for(i=s.length;i--;)s[i].update();if(!n&&(r=t.depsMap[e]))for(i=r.length;i--;)l(t,r[i])},d=function(t,e,n){var s;for(s=e.length;s--;)l(t,e[s],n)},g=function(t){var e,n,s,i,r;for(n=t.changes,s=t.upstreamChanges,t.changes=[],t.upstreamChanges=[],e=s.length;e--;)i=s[e],v(t,i,!0);for(e=n.length;e--;)i=n[e],v(t,i);for(;t.deferred.length;)r=t.deferred.pop(),r.update(),r.deferred=!1},v=function(t,e,n){var s,i,r;if(s=t.refs[e])for(r=s.length;r--;)s[r].update();if(!n&&(i=t.refsMap[e]))for(r=i.length;r--;)v(t,i[r])},y=function(t,e){var n,s,i,r,o,h,a,u;for(n=t.statesman,s=t.keypath,e?(a=n.refs,u=n.refsMap):(a=n.deps,u=n.depsMap),i=a[s]||(a[s]=[]),i[i.length]=t,r=s.split(".");r.length;)r.pop(),o=r.join("."),h=u[o]||(u[o]=[]),void 0===h[s]&&(h[s]=0,h[h.length]=s),h[s]+=1,s=o},m=function(t,e){var n,s,i,r,o,h,a,u;for(n=t.statesman,s=t.keypath,e?(a=n.refs,u=n.refsMap):(a=n.deps,u=n.depsMap),i=a[s],i.splice(i.indexOf(t),1),r=s.split(".");r.length;)r.pop(),o=r.join("."),h=u[o],h[s]-=1,h[s]||(h.splice(h.indexOf(s),1),h[s]=void 0),s=o},r={total:function(t){return t.reduce(function(t,e){return t+e})}},n=function(t,e){var n,s,i=this;this.path=t,this.pathDot=t+".",this.root=e,this.subs={},n=RegExp("^"+this.pathDot.replace(".","\\.")),s=this.pathDot.length,this.root.on("change",function(t){var e,r,o,h;o={};for(r in t)t.hasOwnProperty(r)&&n.test(r)&&(e=r.substring(s),o[e]=t[r],h=!0);h&&i.fire("change",o)})},x.add=function(t,e){this.root.add(this.pathDot+t,e)},function(t){var e;t.compute=function(t,n){var s,i;if("object"==typeof t){s={};for(i in t)t.hasOwnProperty(i)&&(s[i]=e(this,i,t));return s}return e(this,t,n)},e=function(t,e,n){var s,r=t.pathDot;if("string"==typeof n)return n=i(n,t.root,r),t.root.compute(r+e,n);if("function"==typeof n&&(n=n()),n.dependsOn)for("string"==typeof n.dependsOn&&(n.dependsOn=[n.dependsOn]),s=n.dependsOn.length;s--;)n.dependsOn=r+n.dependsOn;return n.context||(n.context=t),t.root.compute(r+e,n)}}(x),x.get=function(t){return t?this.root.get(this.pathDot+t):this.root.get(this.path)},x.observe=function(t,e,n){var s,i;if("object"==typeof t){n=e,i={};for(s in t)t.hasOwnProperty(s)&&(i[this.pathDot+s]=t[s]);return n?n.context=n.context||this:n={context:this},this.root.observe(i,n)}return"function"==typeof t?(n=e,e=t,t=this.path):t=""===t?this.path:this.pathDot+t,n?n.context=n.context||this:n={context:this},this.root.observe(t,e,n)},x.removeComputedValue=function(t){return this.root.removeComputedValue(this.pathDot+t),this},x.reset=function(t){return this.root.set(this.path,t),this},x.set=function(t,e,n){var s,i;if("object"==typeof t){n=e,i={};for(s in t)t.hasOwnProperty(s)&&(i[this.pathDot+s]=t[s]);return this.root.set(i,n),this}return this.root.set(this.pathDot+t,e,n),this},x.subset=function(t){return this.root.subset(this.pathDot+t)},x.subtract=function(t,e){this.root.subtract(this.pathDot+t,e)},x.toggle=function(t){this.root.toggle(this.pathDot+t)},s={},s.on=function(t,e){var n,s,i,r=this;if("object"==typeof t){i=[];for(s in t)t.hasOwnProperty(s)&&(i[i.length]=this.on(s,t[s]));return{cancel:function(){for(;i.length;)i.pop().cancel()}}}return this.subs[t]||(this.subs[t]=[]),n=this.subs[t],n[n.length]=e,{cancel:function(){r.off(t,e)}}},s.once=function(t,e){var n,s,i,r,o=this;if("object"==typeof t){i=[];for(s in t)t.hasOwnProperty(s)&&(i[i.length]=this.once(s,t[s]));return{cancel:function(){for(;i.length;)i.pop().cancel()}}}return this.subs[t]||(this.subs[t]=[]),n=this.subs[t],r=function(){e.apply(o,arguments),o.off(t,r)},n[n.length]=r,{cancel:function(){o.off(t,r)}}},s.off=function(t,e){var n,s;return t?e?(n=this.subs[t],n&&(s=n.indexOf(e),-1!==s&&n.splice(s,1),n.length||delete this.subs[t]),this):(delete this.subs[t],this):(this.subs={},this)},s.fire=function(t){var e,n,s,i;if(e=this.subs[t],!e)return this;for(s=e.length,n=Array.prototype.slice.call(arguments,1),i=0;s>i;i+=1)e[i].apply(this,n)},function(){var t=/\$\{\s*([a-zA-Z0-9_$\[\]\.]+)\s*\}/g;i=function(n,s,i){var r,o,h,a;return i=i||"",o=[],r=n.replace(t,function(t,e){return-1===o.indexOf(e)&&(o[o.length]=i+e),'m.get("'+i+e+'")'}),h=Function("utils","var m=this;return "+r),a=h.bind?h.bind(s,e.utils):function(){return h.call(s,e.utils)},{compiled:a,dependsOn:o,cache:!!o.length}}}(),o=function(t,e){return null===t&&null===e?!0:"object"==typeof t||"object"==typeof e?!1:t===e},a=function(t){return j[t]||(j[t]=t.replace(/\[\s*([0-9]+)\s*\]/g,".$1"))},u=function(t,e){var n;for(n in e)e.hasOwnProperty(n)&&(t[n]=e[n])},u(O,s),u(x,s),e.prototype=O,n.prototype=x,e.utils=r,"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):t.Statesman=e})(this);