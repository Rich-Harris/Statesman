(function(t){"use strict";var e=function(){var t,e,r,o,s,i,n,h=/^\s*[0-9]+\s*$/;return t=function(t){this._data=t||{},this._observers={},this._computed={},this._subsets={},this._queue=[],this._cache={},this._cacheMap={}},t.prototype={reset:function(t,e){return this._data={},this.set(t,{silent:!0}),this._notifyAllObservers(e?e.force:!1),this},set:function(t,e,o){var i,n,u,c,a,f;if("object"==typeof t){this._queueing=!0,o=e;for(i in t)t.hasOwnProperty(i)&&this.set(i,t[i],o);return this._dispatchQueue(),this._queueing=!1,this}if(t=r(t),f=this._computed[t],a=this._referToCache?this._cache[t]:this.get(t),o=o||{},a===e)return(!s(a,e)||o.force&&!o.silent)&&this._notifyObservers(t,o.force),void 0;if(f=this._computed[t])if(this._computing)f.override=!1;else{if(f.readonly)throw'The computed value "'+t+'" has readonly set true and cannot be changed manually';f.override=!0}for(this._clearCache(t),n=t.split("."),c=this._data;n.length>1;)u=n.shift(),c[u]||c[u]||(c[u]=h.test(n[0])?[]:{}),c=c[u];return u=n[0],c[u]=e,o.silent||this._notifyObservers(t,o.force),this},get:function(t){var e,o,s,i,n,h,u;return t?(n=r(t),(h=this._computed[n])&&(this._referToCache||h.cache||h.override||(this._cache[n]=h.getter())),this._cache.hasOwnProperty(n)?this._cache[n]:(e=n.split("."),o=e.pop(),s=e.join("."),i=this.get(s),"object"==typeof i&&i.hasOwnProperty(o)?(u=i[o],this._cache[n]=u,this._cacheMap[s]||(this._cacheMap[s]=[]),this._cacheMap[s].push(n)):u=void 0,u)):this._data},observe:function(t,e,o){var s,i,n,h=this,u=[];if("function"==typeof t&&(o=e,e=t,t=""),"object"==typeof t){o=e;for(n in t)t.hasOwnProperty(n)&&(u[u.length]=this.observe(n,t[n],o));return u}if(o||(o={}),"string"!=typeof t||"function"!=typeof e||"object"!=typeof o)throw"Invalid arguments to observe()";for(s=t=r(t),i=function(t){var r,i;h._observers[t]||(h._observers[t]=[]),r=h._observers[t],i={observedKeypath:t,originalKeypath:s,callback:e,group:u,context:o.context||h},r[r.length]=i,u[u.length]=i};-1!==t.lastIndexOf(".");)i(t),t=t.substr(0,t.lastIndexOf("."));return i(t),(!o.hasOwnProperty("init")||o.init)&&e.call(o.context||this,this.get(s)),u.__previousValue=h.get(s),u},observeOnce:function(t,e,r){var o,s=this;return r||(r={}),r.init=!1,o=this.observe(t,function(t,r){e.call(this,t,r),s.unobserve(o)},r)},unobserve:function(t){var e,o,s;if(t.hasOwnProperty("length"))for(;t.length;)this.unobserve(t.shift());else if(s=r(t.observedKeypath),e=this._observers[s],e&&(o=e.indexOf(t),-1!==o))return e.splice(o,1),0===e.length&&delete this._observers[s],this},compute:function(e,o){var s,i,h,u,c,a,f,p,l,_,g,v,b=this;if("object"==typeof e){g={};for(s in e)e.hasOwnProperty(s)&&(g[s]=this.compute(s,e[s]));return g}if(e=r(e),this._computed[e]&&this.removeComputedValue(e),"string"==typeof o?(v=n(o),c=v.fn,u=v.triggers,a=this,i=function(){return console.log("using compiled function"),c.call(a,t.utils)}):(c=o.fn,u=o.triggers||o.trigger,a=o.context||this,u?"string"==typeof u&&(u=[u]):u=[],i=function(){var t,e=[];for(t=u.length;t--;)e[t]=b.get(u[t]);return l=o.fn.apply(a,e)}),-1!==u.indexOf(e))throw"A computed value cannot be its own trigger";if(f=u.length?o.cache===!1?!1:!0:!1,p=o.readonly===!1?!1:!0,_=[],h=function(){var t;g.cache=!0,b._computing=!0,t=i(),b.set(e,t),b._computing=!1,g.cache=f},g=this._computed[e]={getter:i,setter:h,cache:f||!1,readonly:p,observerGroups:_},h(),s=u.length,!s&&f)throw"Cached computed values must have at least one trigger";for(;s--;)_[_.length]=this.observe(u[s],h,{init:!1,context:a});return l},removeComputedValue:function(t){for(var e=this._computed[t].observerGroups;e.length;)this.unobserve(e.pop());return delete this._computed[t],this},_clearCache:function(t){var e=this._cacheMap[t];if(delete this._cache[t],e)for(;e.length;)this._clearCache(e.pop())},_notifyObservers:function(t,e){var r,o,i,n,h,u=this,c=this._observers[t]||[];for(r=0;c.length>r;r+=1)o=c[r],n=o.group.__previousValue,i=u.get(o.originalKeypath),o.group.__previousValue=i,(e||!s(i,n))&&(this._queueing?this._addToQueue(o.callback,i,n,o.context||this):o.callback.call(o.context||this,i,n));for(h=function(t){var e,r,s=u._observers[t];if(s)for(r=s.length;r--;)o=s[r],o.observedKeypath===o.originalKeypath&&(e=u.get(t),u._queueing?u._addToQueue(o.callback,e,e):o.callback.call(o.context||this,e,e))};-1!==t.lastIndexOf(".");)t=t.substr(0,t.lastIndexOf(".")),h(t);h("")},_notifyAllObservers:function(t){var e,r,o,i,n,h,u;for(e in this._observers)if(this._observers.hasOwnProperty(e))for(r=this._observers[e],n=r.length,i=0;n>i;i+=1)o=r[i],h=o.group.__previousValue,u=this.get(o.originalKeypath),(t||!s(u,h))&&o.callback.call(o.context||this,u,h),o.group.__previousValue=u},_addToQueue:function(t,e,r,o){var s;for(s=0;this._queue.length>s;s+=1)if(this._queue[s].c===t){this._queue.splice(s,1);break}this._queue[this._queue.length]={c:t,v:e,p:r,cx:o}},_dispatchQueue:function(){for(var t;this._queue.length;)t=this._queue.shift(),t.c.call(t.cx,t.v,t.p)}},e={},r=function(t){return e[t]||(e[t]=t.replace(/\[\s*([0-9]+)\s*\]/g,".$1"))},o=function(t){return r(t).split(".")},s=function(t,e){return null===t&&null===e?!0:"object"==typeof t||"object"==typeof e?!1:t===e},i=/\$\{\s*([a-zA-Z0-9_$\[\]\.]+)\s*\}/g,n=function(t){var e,r,o;return e={},r=[],o=t.replace(i,function(t,e){return r[r.length]=e,'this.get("'+e+'")'}),e.triggers=r,e.fn=Function("utils","return "+o),e},t.utils={total:function(t){return t.reduce(function(t,e){return t+e})}},t}();(function(t){var e;t.prototype.subset=function(t){if(!t)throw"No subset path specified";return this._subsets[t]||(this._subsets[t]=new e(t,this)),this._subsets[t]},e=function(t,e){this._path=t,this._pathDot=t+".",this._root=e},e.prototype={reset:function(t){return this._root.set(this._path,t),this},set:function(t,e,r){var o,s;if("object"==typeof t){r=e,s={};for(o in t)t.hasOwnProperty(o)&&(s[this._pathDot+o]=t[o]);return this._root.set(s,r),this}return this._root.set(this._pathDot+t,e,r),this},get:function(t){return t?this._root.get(this._pathDot+t):this._root.get(this._path)},observe:function(t,e,r){var o,s,i;if(o=Array.prototype.slice.call(arguments),"object"==typeof t){r=e,i={};for(s in t)i[this._pathDot+s]=t[s];return r?r.context=r.context||this:r={context:this},this._root.observe(i,r)}return"function"==typeof t?(r=e,e=t,t=this._path):t=""===t?this._path:this._pathDot+t,r?r.context=r.context||this:r={context:this},this._root.observe(t,e,r)},observeOnce:function(t,e,r){r?r.context=r.context||this:r={context:this};var o=this._root.observeOnce(this._pathDot+t,e,r);return o},unobserve:function(t){return this._root.unobserve(t),this},compute:function(t,e){var r,o,s,i,n=this;if(i=this._pathDot,e.context=e.context||this,s=function(t){var e,r;for(e=t.triggers||t.trigger,"string"==typeof e&&(e=[e]),e&&(delete t.triggers,delete t.trigger),r=e.length;r--;)e[r]=i+e[r];return t.triggers=e,t.context||(t.context=n),t},"object"==typeof t){o={};for(r in t)o[this._pathDot+r]=s(t[r]);return this._root.compute(o)}return this._root.compute(this._pathDot+t,s(e))},removeComputedValue:function(t){return this._root.removeComputedValue(this._pathDot+t),this},subset:function(t){return this._root.subset(this._pathDot+t)}}})(e),"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):t.Statesman=e})(this);