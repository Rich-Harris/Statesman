(function(t){"use strict";var e=function(){var t,e,o,r,s,i=/^\s*[0-9]+\s*$/;return t=function(t){this._data=t||{},this._observers={},this._computed={},this._subsets={},this._queue=[],this._cache={},this._cacheMap={}},t.prototype={reset:function(t,e){return this._data={},this.set(t,{silent:!0}),this._notifyAllObservers(e?e.force:!1),this},set:function(t,e,o){var n,h,u,c,a,f;if("object"==typeof t){this._queueing=!0,o=e;for(n in t)t.hasOwnProperty(n)&&this.set(n,t[n],o);return this._dispatchQueue(),this._queueing=!1,this}if(o=o||{},this._computed.hasOwnProperty(t))if(f=this._computed[t],this._computing)f.override=!1,this._computing=!1;else{if(f.readonly)throw'The computed value "'+t+'" has readonly set true and cannot be changed manually';f.override=!0}for(this._referToCache=!0,a=this.get(t),this._referToCache=!1,h=r(t),t=h.join("."),c=this._data;h.length>1;)u=h.shift(),c[u]||c[u]||(c[u]=i.test(h[0])?[]:{}),c=c[u];return u=h[0],c[u]=e,o.silent||!o.force&&s(a,e)||this._notifyObservers(t,e,o.force),this},get:function(t){var e,o,s;if(!t)return this._data;for(this._referToCache||(s=this._computed[t],!s||s.cache||s.override||s.setter()),e=r(t),o=this._data;e.length;){try{o=o[e.shift()]}catch(i){return void 0}if(void 0===o)return void 0}return o},observe:function(t,e,r){var s,i,n,h=this,u=[];if("function"==typeof t&&(r=e,e=t,t=""),"object"==typeof t){r=e;for(n in t)t.hasOwnProperty(n)&&(u[u.length]=this.observe(n,t[n],r));return u}if(r||(r={}),"string"!=typeof t||"function"!=typeof e||"object"!=typeof r)throw"Invalid arguments to observe()";for(s=t=o(t),i=function(t){var o,i;o=h._observers[t]=h._observers[t]||[],i={observedKeypath:t,originalKeypath:s,callback:e,group:u,context:r.context||h},o[o.length]=i,u[u.length]=i};-1!==t.lastIndexOf(".");)i(t),t=t.substr(0,t.lastIndexOf("."));return i(t),(!r.hasOwnProperty("init")||r.init)&&e.call(r.context||this,this.get(s)),u.__previousValue=h.get(s),u},observeOnce:function(t,e,o){var r,s=this;return o||(o={}),o.init=!1,r=this.observe(t,function(t,o){e.call(this,t,o),s.unobserve(r)},o)},unobserve:function(t){var e,r,s;if(t.hasOwnProperty("length"))for(;t.length;)this.unobserve(t.shift());else if(s=o(t.observedKeypath),e=this._observers[s],e&&(r=e.indexOf(t),-1!==r))return e.splice(r,1),0===e.length&&delete this._observers[s],this},compute:function(t,e){var o,r,s,i,n,h,u,c,a,f,p,l=this;if("object"==typeof t){p={};for(o in t)t.hasOwnProperty(o)&&(p[o]=this.compute(o,t[o]));return p}if(this._computed[t]&&this.removeComputedValue(t),n=e.fn,i=e.triggers||e.trigger,h=e.context||this,i?"string"==typeof i&&(i=[i]):i=[],-1!==i.indexOf(t))throw"A computed value cannot be its own trigger";if(u=i.length?e.cache===!1?!1:!0:!1,c=e.readonly===!1?!1:!0,f=[],r=function(){var t,o=[];for(t=i.length;t--;)o[t]=l.get(i[t]);return a=e.fn.apply(h,o)},s=function(){p.cache=!0,l._computing=!0,l.set(t,r()),p.cache=u},p=this._computed[t]={getter:r,setter:s,cache:u||!1,readonly:c,observerGroups:f},s(),o=i.length,!o&&u)throw"Cached computed values must have at least one trigger";for(;o--;)f[f.length]=this.observe(i[o],s,{init:!1,context:h});return a},removeComputedValue:function(t){for(var e=this._computed[t].observerGroups;e.length;)this.unobserve(e.pop());return delete this._computed[t],this},_notifyObservers:function(t,e,o){var r,i,n,h,u,c=this,a=this._observers[t]||[];for(r=0;a.length>r;r+=1)i=a[r],h=i.group.__previousValue,n=t!==i.originalKeypath?c.get(i.originalKeypath):e,i.group.__previousValue=n,(o||!s(n,h))&&(this._queueing?this._addToQueue(i.callback,n,h,i.context||this):i.callback.call(i.context||this,n,h));for(u=function(t){var o,r=c._observers[t];if(r)for(o=r.length;o--;)i=r[o],i.observedKeypath===i.originalKeypath&&(e=c.get(t),c._queueing?c._addToQueue(i.callback,e,e):i.callback.call(i.context||this,e,e))};-1!==t.lastIndexOf(".");)t=t.substr(0,t.lastIndexOf(".")),u(t);u("")},_notifyAllObservers:function(t){var e,o,r,i,n,h,u;for(e in this._observers)if(this._observers.hasOwnProperty(e))for(o=this._observers[e],n=o.length,i=0;n>i;i+=1)r=o[i],h=r.group.__previousValue,u=this.get(r.originalKeypath),(t||!s(u,h))&&r.callback.call(r.context||this,u,h),r.group.__previousValue=u},_addToQueue:function(t,e,o,r){var s;for(s=0;this._queue.length>s;s+=1)if(this._queue[s].c===t){this._queue.splice(s,1);break}this._queue[this._queue.length]={c:t,v:e,p:o,cx:r}},_dispatchQueue:function(){for(var t;this._queue.length;)t=this._queue.shift(),t.c.call(t.cx,t.v,t.p)}},e={},o=function(t){return e[t]||(e[t]=t.replace(/\[\s*([0-9]+)\s*\]/g,".$1"))},r=function(t){return o(t).split(".")},s=function(t,e){return null===t&&null===e?!0:"object"==typeof t||"object"==typeof e?!1:t===e},t}();(function(t){var e;t.prototype.subset=function(t){if(!t)throw"No subset path specified";return this._subsets[t]||(this._subsets[t]=new e(t,this)),this._subsets[t]},e=function(t,e){this._path=t,this._pathDot=t+".",this._root=e},e.prototype={reset:function(t){return this._root.set(this._path,t),this},set:function(t,e,o){var r,s;if("object"==typeof t){o=e,s={};for(r in t)t.hasOwnProperty(r)&&(s[this._pathDot+r]=t[r]);return this._root.set(s,o),this}return this._root.set(this._pathDot+t,e,o),this},get:function(t){return t?this._root.get(this._pathDot+t):this._root.get(this._path)},observe:function(t,e,o){var r,s,i;if(r=Array.prototype.slice.call(arguments),"object"==typeof t){o=e,i={};for(s in t)i[this._pathDot+s]=t[s];return o?o.context=o.context||this:o={context:this},this._root.observe(i,o)}return"function"==typeof t?(o=e,e=t,t=this._path):t=""===t?this._path:this._pathDot+t,o?o.context=o.context||this:o={context:this},this._root.observe(t,e,o)},observeOnce:function(t,e,o){o?o.context=o.context||this:o={context:this};var r=this._root.observeOnce(this._pathDot+t,e,o);return r},unobserve:function(t){return this._root.unobserve(t),this},compute:function(t,e){var o,r,s,i,n=this;if(i=this._pathDot,e.context=e.context||this,s=function(t){var e,o;for(e=t.triggers||t.trigger,"string"==typeof e&&(e=[e]),e&&(delete t.triggers,delete t.trigger),o=e.length;o--;)e[o]=i+e[o];return t.triggers=e,t.context||(t.context=n),t},"object"==typeof t){r={};for(o in t)r[this._pathDot+o]=s(t[o]);return this._root.compute(r)}return this._root.compute(this._pathDot+t,s(e))},removeComputedValue:function(t){return this._root.removeComputedValue(this._pathDot+t),this},subset:function(t){return this._root.subset(this._pathDot+t)}}})(e),"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):t.Statesman=e})(this);