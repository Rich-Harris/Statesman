(function(t){"use strict";var e=function(){return{}}();(function(t){t.on=function(t,e){var r,s,i,o=this;if("object"==typeof t){i=[];for(s in t)t.hasOwnProperty(s)&&(i[i.length]=this.on(s,t[s]));return{cancel:function(){for(;i.length;)i.pop().cancel()}}}return this.subs[t]||(this.subs[t]=[]),r=this.subs[t],r[r.length]=e,{cancel:function(){o.off(t,e)}}},t.once=function(t,e){var r,s,i,o,n=this;if("object"==typeof t){i=[];for(s in t)t.hasOwnProperty(s)&&(i[i.length]=this.once(s,t[s]));return{cancel:function(){for(;i.length;)i.pop().cancel()}}}return this.subs[t]||(this.subs[t]=[]),r=this.subs[t],o=function(){e.apply(n,arguments),n.off(t,o)},r[r.length]=o,{cancel:function(){n.off(t,o)}}},t.off=function(t,e){var r,s;return t?e?(r=this.subs[t],r&&(s=r.indexOf(e),-1!==s&&r.splice(s,1),r.length||delete this.subs[t]),this):(delete this.subs[t],this):(this.subs={},this)},t.fire=function(t){var e,r,s,i;if(e=this.subs[t],!e)return this;for(s=e.length,r=Array.prototype.slice.call(arguments,1),i=0;s>i;i+=1)e[i].apply(this,r)}})(e);var r;(function(t){var e,s,i,o,n,h=/^\s*[0-9]+\s*$/;return r=function(t){this._data=t||{},this._observers={},this._computed={},this._subsets={},this._queue=[],this.subs={},this._cache={},this._cacheMap={}},r.prototype={reset:function(t,e){return this._data={},this.fire("reset"),this.set(t,{silent:!0}),this._notifyAllObservers(e?e.force:!1),this},set:function(t,e,r){var i,n,u,c,a,f;if("object"==typeof t){this._queueing=!0,r=e;for(i in t)t.hasOwnProperty(i)&&this.set(i,t[i],r);return this._dispatchQueue(),this._queueing=!1,this}if(this.fire("set",t,e,r),this.fire("set:"+t,e,r),t=s(t),f=this._computed[t],a=this._referToCache?this._cache[t]:this.get(t),r=r||{},a===e)return(!o(a,e)||r.force&&!r.silent)&&this._notifyObservers(t,r.force),void 0;if(f=this._computed[t])if(this._computing)f.override=!1;else{if(f.readonly)throw'The computed value "'+t+'" has readonly set true and cannot be changed manually';f.override=!0}for(this._clearCache(t),n=t.split("."),c=this._data;n.length>1;)u=n.shift(),c[u]||c[u]||(c[u]=h.test(n[0])?[]:{}),c=c[u];return u=n[0],c[u]=e,r.silent||this._notifyObservers(t,r.force),this},get:function(t){var e,r,i,o,n,h,u;return t?(n=s(t),(h=this._computed[n])&&(this._referToCache||h.cache||h.override||(this._cache[n]=h.getter())),this._cache.hasOwnProperty(n)?this._cache[n]:(e=n.split("."),r=e.pop(),i=e.join("."),o=this.get(i),"object"==typeof o&&o.hasOwnProperty(r)?(u=o[r],this._cache[n]=u,this._cacheMap[i]||(this._cacheMap[i]=[]),this._cacheMap[i].push(n)):u=void 0,u)):this._data},observe:function(t,e,r){var i,o,n,h=this,u=[];if("function"==typeof t&&(r=e,e=t,t=""),"object"==typeof t){r=e;for(n in t)t.hasOwnProperty(n)&&(u[u.length]=this.observe(n,t[n],r));return u}if(r||(r={}),"string"!=typeof t||"function"!=typeof e||"object"!=typeof r)throw"Invalid arguments to observe()";for(i=t=s(t),o=function(t){var s,o;h._observers[t]||(h._observers[t]=[]),s=h._observers[t],o={observedKeypath:t,originalKeypath:i,callback:e,group:u,context:r.context||h},s[s.length]=o,u[u.length]=o};-1!==t.lastIndexOf(".");)o(t),t=t.substr(0,t.lastIndexOf("."));return o(t),(!r.hasOwnProperty("init")||r.init)&&e.call(r.context||this,this.get(i)),u.__previousValue=h.get(i),u},observeOnce:function(t,e,r){var s,i=this;return r||(r={}),r.init=!1,s=this.observe(t,function(t,r){e.call(this,t,r),i.unobserve(s)},r)},unobserve:function(t){var e,r,i;if(t.hasOwnProperty("length"))for(;t.length;)this.unobserve(t.shift());else if(i=s(t.observedKeypath),e=this._observers[i],e&&(r=e.indexOf(t),-1!==r))return e.splice(r,1),0===e.length&&delete this._observers[i],this},compute:function(t,e){var i,o,n,h,u,c,a,f,p,l,_,g,v=this;if("object"==typeof t){_={};for(i in t)t.hasOwnProperty(i)&&(_[i]=this.compute(i,t[i]));return _}if(!e)throw Error("Bad arguments to compute()");if(t=s(t),this._computed[t]&&this.removeComputedValue(t),"string"==typeof e?(g=r.compile(e,this),o=g.getter,h=g.triggers):"string"==typeof e.fn?(g=r.compile(e.fn,e.context||this,e.prefix),o=g.getter,h=g.triggers):(u=e.fn,h=e.triggers||e.trigger,c=e.context||this,h?"string"==typeof h&&(h=[h]):h=[],o=function(){var t,e=[];for(t=h.length;t--;)e[t]=v.get(h[t]);return p=u.apply(c,e)}),-1!==h.indexOf(t))throw"A computed value cannot be its own trigger";if(a=h.length?e.cache===!1?!1:!0:!1,f=e.readonly===!1?!1:!0,l=[],n=function(){var e;_.cache=!0,v._computing=!0,e=o(),v.set(t,e),v._computing=!1,_.cache=a},_=this._computed[t]={getter:o,setter:n,cache:a||!1,readonly:f,observerGroups:l},n(),i=h.length,!i&&a)throw Error("Cached computed values must have at least one trigger");for(;i--;)l[l.length]=this.observe(h[i],n,{init:!1,context:c});return p},removeComputedValue:function(t){for(var e=this._computed[t].observerGroups;e.length;)this.unobserve(e.pop());return delete this._computed[t],this},on:t.on,off:t.off,once:t.once,fire:t.fire,_clearCache:function(t){var e=this._cacheMap[t];if(delete this._cache[t],e)for(;e.length;)this._clearCache(e.pop())},_notifyObservers:function(t,e){var r,s,i,n,h,u=this,c=this._observers[t]||[];for(r=0;c.length>r;r+=1)s=c[r],n=s.group.__previousValue,i=u.get(s.originalKeypath),s.group.__previousValue=i,(e||!o(i,n))&&(this._queueing?this._addToQueue(s.callback,i,n,s.context||this):s.callback.call(s.context||this,i,n));for(h=function(t){var e,r,i=u._observers[t];if(i)for(r=i.length;r--;)s=i[r],s.observedKeypath===s.originalKeypath&&(e=u.get(t),u._queueing?u._addToQueue(s.callback,e,e):s.callback.call(s.context||this,e,e))};-1!==t.lastIndexOf(".");)t=t.substr(0,t.lastIndexOf(".")),h(t);h("")},_notifyAllObservers:function(t){var e,r,s,i,n,h,u;for(e in this._observers)if(this._observers.hasOwnProperty(e))for(r=this._observers[e],n=r.length,i=0;n>i;i+=1)s=r[i],h=s.group.__previousValue,u=this.get(s.originalKeypath),(t||!o(u,h))&&s.callback.call(s.context||this,u,h),s.group.__previousValue=u},_addToQueue:function(t,e,r,s){var i;for(i=0;this._queue.length>i;i+=1)if(this._queue[i].c===t){this._queue.splice(i,1);break}this._queue[this._queue.length]={c:t,v:e,p:r,cx:s}},_dispatchQueue:function(){for(var t;this._queue.length;)t=this._queue.shift(),t.c.call(t.cx,t.v,t.p)}},e={},s=function(t){return e[t]||(e[t]=t.replace(/\[\s*([0-9]+)\s*\]/g,".$1"))},i=function(t){return s(t).split(".")},o=function(t,e){return null===t&&null===e?!0:"object"==typeof t||"object"==typeof e?!1:t===e},n=/\$\{\s*([a-zA-Z0-9_$\[\]\.]+)\s*\}/g,r.compile=function(t,e,s){var i,o,h,u;return s=s||"",i=[],o=t.replace(n,function(t,e){return-1===i.indexOf(e)&&(i[i.length]=s+e),'m.get("'+e+'")'}),h=Function("utils","var m = this; return "+o),u=h.bind?h.bind(e,r.utils):function(){return h.call(e,r.utils)},{getter:u,triggers:i}},r.utils={total:function(t){return t.reduce(function(t,e){return t+e})}},r})(e),function(t,e){var r;t.prototype.subset=function(t){if(!t)throw"No subset path specified";return this._subsets[t]||(this._subsets[t]=new r(t,this)),this._subsets[t]},r=function(t,e){var r,s,i=this;this._path=t,this._pathDot=t+".",this._root=e,this.subs={},r=RegExp("^"+this._pathDot.replace(".","\\.")),s=this._pathDot.length,this._root.on("set",function(t,e,o){var n;return t===this._path?(i.fire("reset"),void 0):(r.test(t)&&(n=t.substring(s),i.fire("set",n,e,o),i.fire("set:"+n,e,o)),void 0)})},r.prototype={reset:function(t){return this._root.set(this._path,t),this},set:function(t,e,r){var s,i;if("object"==typeof t){r=e,i={};for(s in t)t.hasOwnProperty(s)&&(i[this._pathDot+s]=t[s]);return this._root.set(i,r),this}return this._root.set(this._pathDot+t,e,r),this},get:function(t){return t?this._root.get(this._pathDot+t):this._root.get(this._path)},observe:function(t,e,r){var s,i,o;if(s=Array.prototype.slice.call(arguments),"object"==typeof t){r=e,o={};for(i in t)o[this._pathDot+i]=t[i];return r?r.context=r.context||this:r={context:this},this._root.observe(o,r)}return"function"==typeof t?(r=e,e=t,t=this._path):t=""===t?this._path:this._pathDot+t,r?r.context=r.context||this:r={context:this},this._root.observe(t,e,r)},observeOnce:function(t,e,r){r?r.context=r.context||this:r={context:this};var s=this._root.observeOnce(this._pathDot+t,e,r);return s},unobserve:function(t){return this._root.unobserve(t),this},compute:function(t,e){var r,s,i,o,n=this;if(o=this._pathDot,e.context=e.context||this,i=function(t){var e,r;if("string"==typeof t)return{fn:t,context:n,prefix:o};for(e=t.triggers||t.trigger,"string"==typeof e&&(e=[e]),e&&(delete t.triggers,delete t.trigger),r=e.length;r--;)e[r]=o+e[r];return t.triggers=e,t.context||(t.context=n),t},"object"==typeof t){s={};for(r in t)s[this._pathDot+r]=i(t[r]);return this._root.compute(s)}return this._root.compute(this._pathDot+t,i(e))},removeComputedValue:function(t){return this._root.removeComputedValue(this._pathDot+t),this},subset:function(t){return this._root.subset(this._pathDot+t)},on:e.on,off:e.off,once:e.once,fire:e.fire}}(r,e),"undefined"!=typeof module&&module.exports?module.exports=r:"function"==typeof define&&define.amd?define(function(){return r}):t.Statesman=r})(this);