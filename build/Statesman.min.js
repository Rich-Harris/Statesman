(function(t){"use strict";var e,r,s,o,i,n,a,h,u,c,l,f,p={},_={},v={};try{Object.defineProperty({},"test",{value:0}),Object.defineProperties({},{test:{value:0}}),l=Object.defineProperty,f=Object.defineProperties}catch(d){l=function(t,e,r){t[e]=r.value},f=function(t,e){var r;for(r in e)e.hasOwnProperty(r)&&l(t,r,e[r])}}(function(){var t=/\$\{\s*([a-zA-Z0-9_$\[\]\.]+)\s*\}/g;o=function(r,s,o){var i,n,a,h;return o=o||"",i=[],n=r.replace(t,function(t,e){return-1===i.indexOf(e)&&(i[i.length]=o+e),'m.get("'+e+'")'}),a=Function("utils","var m=this;try{return "+n+"}catch(e){return undefined}"),h=a.bind?a.bind(s,e.utils):function(){return a.call(s,e.utils)},{getter:h,triggers:i}}})(),e=function(t){f(this,{_data:{value:t||{},writable:!0},_subs:{value:{},writable:!0},_cache:{value:{}},_cacheMap:{value:{}},_deps:{value:{}},_depsMap:{value:{}},_observers:{value:{}},_computed:{value:{}},_subsets:{value:{}},_observerQueue:{value:[]},_silentSetterPayload:{value:null,writable:!0},_setterPayload:{value:null,writable:!0},_consolidatingObservers:{value:0,writable:!0},_consolidatingSetters:{value:0,writable:!0},_computing:{value:0,writable:!0}})},p.compute=function(t,r){var s,o,i,n,h,u,c,l,f,p,_,v,d=this;if("object"==typeof t){_={};for(s in t)t.hasOwnProperty(s)&&(_[s]=this.compute(s,t[s]));return _}if(!r)throw Error("Bad arguments to compute()");if(t=a(t),this._computed[t]&&this.removeComputedValue(t),"string"==typeof r?(v=e.compile(r,this),o=v.getter,n=v.triggers):"string"==typeof r.fn?(v=e.compile(r.fn,r.context||this,r.prefix),o=v.getter,n=v.triggers):(h=r.fn,n=r.triggers||r.trigger,u=r.context||this,n?"string"==typeof n&&(n=[n]):n=[],o=function(){var t,e=[];for(t=n.length;t--;)e[t]=d.get(n[t]);return f=h.apply(u,e)}),-1!==n.indexOf(t))throw"A computed value cannot be its own trigger";if(c=n.length?r.cache===!1?!1:!0:!1,l=r.readonly===!1?!1:!0,p=[],i=function(){var e;_.cache=!0,d._computing+=1,e=o(),d.set(t,e),d._computing-=1,_.cache=c},_=this._computed[t]={getter:o,setter:i,cache:c||!1,readonly:l,observerGroups:p},i(),s=n.length,!s&&c)throw Error("Cached computed values must have at least one trigger");for(;s--;)p[p.length]=this.observe(n[s],i,{init:!1,context:u});return f},p.get=function(t){var e,r,s,o,i,n,h;return t?(i=a(t),(n=this._computed[i])&&(this._referToCache||n.cache||n.override||(this._cache[i]=n.getter())),this._cache.hasOwnProperty(i)?this._cache[i]:(e=i.split("."),r=e.pop(),s=e.join("."),o=this.get(s),"object"==typeof o&&o.hasOwnProperty(r)?(h=o[r],this._cache[i]=h,this._cacheMap[s]||(this._cacheMap[s]=[]),this._cacheMap[s].push(i)):h=void 0,h)):this._data},function(t){var e;t.observe=function(t,r,s){var o,i,n,a;if(a=!s||s.init!==!1,"function"==typeof t&&(s=r,r=t,t=""),"string"==typeof t)return observer=new e(this,t,r,s),s&&s.init===!1||observer.update(),{cancel:function(){observer.teardown()}};if("object"!=typeof t)throw Error("Bad arguments to Statesman.prototype.observe()");o=[];for(i in t)t.hasOwnProperty(i)&&(o[o.length]=new e(this,i,t[i],s));if(a)for(n=o.length;n--;)o[n].update();return{cancel:function(){for(n=o.length;n--;)o[n].teardown()}}},e=function(t,e,r,s){this.statesman=t,this.keypath=e,this.callback=r,this.context=s&&s.context?s.context:t,x(this)},e.prototype={update:function(){var t;if(t=this.statesman.get(this.keypath,!0),!n(t,this.value)){try{this.callback.call(this.context,t,this.value)}catch(e){if(statesman.debug)throw e}this.value=t}},teardown:function(){O(this)}}}(p),p.observeOnce=function(t,e,r){var s,o=this;return r||(r={}),r.init=!1,s=this.observe(t,function(t,r){e.call(this,t,r),o.unobserve(s)},r)},p.removeComputedValue=function(t){for(var e=this._computed[t].observerGroups;e.length;)this.unobserve(e.pop());return delete this._computed[t],this},p.reset=function(t){return this._data={},this.set(t,{silent:!0}),this.fire("reset"),m(this),this},function(t){var e=/^\s*[0-9]+\s*$/;t.set=function(t,r,s){var o,i,h,c,l,f;if(this._consolidatingSetters)return this._addToSetterQueue(t,r,s),void 0;if("object"==typeof t){this._consolidatingObservers+=1,s=r;for(o in t)t.hasOwnProperty(o)&&this.set(o,t[o],s);return this._consolidatingObservers-=1,this._consolidatingObservers||b(this),this}if(this.fire("set",t,r,s),this.fire("set:"+t,r,s),t=a(t),f=this._computed[t],l=this._referToCache?this._cache[t]:this.get(t),s=s||{},l===r)return n(l,r)||s.silent||u(this,t),void 0;if(f=this._computed[t])if(this._computing)f.override=!1;else{if(f.readonly)throw'The computed value "'+t+'" has readonly set true and cannot be changed manually';f.override=!0}for(g(this,t),i=t.split("."),c=this._data;i.length>1;)h=i.shift(),c[h]||c[h]||(c[h]=e.test(i[0])?[]:{}),c=c[h];return h=i[0],c[h]=r,s.silent||u(this,t),this}}(p),p.subset=function(t){if(!t)throw"No subset path specified";return this._subsets[t]||(this._subsets[t]=new r(t,this)),this._subsets[t]},p.unobserve=function(t){var e,r,s;if(t.hasOwnProperty("length"))for(;t.length;)this.unobserve(t.shift());else if(s=a(t.observedKeypath),e=this._observers[s],e&&(r=e.indexOf(t),-1!==r))return e.splice(r,1),0===e.length&&delete this._observers[s],this};var g=function(t,e){var r=t._cacheMap[e];if(delete t._cache[e],r)for(;r.length;)g(t,r.pop())},b=function(t){for(var e;t._observerQueue.length;)e=t._observerQueue.shift(),e.c.call(e.cx,e.v,e.p)},y=function(t){t.set(t._silentSetterPayload,{silent:!0}),t._silentSetterPayload=null,t.set(t._setterPayload),t._setterPayload=null},m=function(t){var e,r,s,o,i,a,h;for(e in t._observers)if(t._observers.hasOwnProperty(e))for(r=t._observers[e],i=r.length,o=0;i>o;o+=1)s=r[o],a=s.group.__previousValue,h=t.get(s.originalKeypath),n(h,a)||s.callback.call(s.context||t,h,a),s.group.__previousValue=h},u=function(t,e){var r,s,o,i,a,h=t._observers[e]||[];for(t._consolidatingSetters+=1,r=0;h.length>r;r+=1)s=h[r],i=s.group.__previousValue,o=t.get(s.originalKeypath),s.group.__previousValue=o,n(o,i)||(this._consolidatingObservers?this._addToQueue(s.callback,o,i,s.context||this):s.callback.call(s.context||this,o,i));for(a=function(e){var r,o,i=t._observers[e];if(i)for(o=i.length;o--;)s=i[o],s.observedKeypath===s.originalKeypath&&(r=t.get(e),t._consolidatingObservers?t._addToQueue(s.callback,r,r):s.callback.call(s.context||this,r,r))};-1!==e.lastIndexOf(".");)e=e.substr(0,e.lastIndexOf(".")),a(e);a(""),this._consolidatingSetters-=1,this._consolidatingSetters||!this._silentSetterPayload&&!this._setterPayload||y(this)},x=function(t){var e,r,s,o,i,n;for(e=t.statesman,r=t.keypath,s=e._deps[r]||(e._deps[r]=[]),s[s.length]=t,o=r.split(".");o.length;)o.pop(),i=o.join("."),n=e._depsMap[i]||(e._depsMap[i]=[]),void 0===n[r]&&(n[r]=0,n[n.length]=r),n[r]+=1,r=i},O=function(t){var e,r,s,o,i,n;for(e=t.statesman,r=t.keypath,s=e._deps[r],s.splice(s.indexOf(t),1),o=r.split(".");o.length;)o.pop(),i=o.join("."),n=e._depsMap[i],n[r]-=1,n[r]||(n.splice(n.indexOf(r),1),n[r]=void 0),r=i};i={total:function(t){return t.reduce(function(t,e){return t+e})}},r=function(t,e){var r,s,o=this;this._path=t,this._pathDot=t+".",this._root=e,this._subs={},r=RegExp("^"+this._pathDot.replace(".","\\.")),s=this._pathDot.length,this._root.on("set",function(t,e,i){var n,a,h;if("object"==typeof t){i=e,h={};for(a in t)t.hasOwnProperty(a)&&r.test(a)&&(n=a.substring(s),h[n]=t[a]);return o.fire("set",h,i),void 0}return t===this._path?(o.fire("reset"),void 0):(r.test(t)&&(n=t.substring(s),o.fire("set",n,e,i)),void 0)})},_.compute=function(t,e){var r,s,o,i,n=this;if(i=this._pathDot,e.context=e.context||this,o=function(t){var e,r;if("string"==typeof t)return{fn:t,context:n,prefix:i};for(e=t.triggers||t.trigger,"string"==typeof e&&(e=[e]),e&&(delete t.triggers,delete t.trigger),r=e.length;r--;)e[r]=i+e[r];return t.triggers=e,t.context||(t.context=n),t},"object"==typeof t){s={};for(r in t)s[this._pathDot+r]=o(t[r]);return this._root.compute(s)}return this._root.compute(this._pathDot+t,o(e))},_.get=function(t){return t?this._root.get(this._pathDot+t):this._root.get(this._path)},_.observe=function(t,e,r){var s,o,i;if(s=Array.prototype.slice.call(arguments),"object"==typeof t){r=e,i={};for(o in t)i[this._pathDot+o]=t[o];return r?r.context=r.context||this:r={context:this},this._root.observe(i,r)}return"function"==typeof t?(r=e,e=t,t=this._path):t=""===t?this._path:this._pathDot+t,r?r.context=r.context||this:r={context:this},this._root.observe(t,e,r)},_.observeOnce=function(t,e,r){r?r.context=r.context||this:r={context:this};var s=this._root.observeOnce(this._pathDot+t,e,r);return s},_.removeComputedValue=function(t){return this._root.removeComputedValue(this._pathDot+t),this},_.reset=function(t){return this._root.set(this._path,t),this},_.set=function(t,e,r){var s,o;if("object"==typeof t){r=e,o={};for(s in t)t.hasOwnProperty(s)&&(o[this._pathDot+s]=t[s]);return this._root.set(o,r),this}return this._root.set(this._pathDot+t,e,r),this},_.subset=function(t){return this._root.subset(this._pathDot+t)},_.unobserve=function(t){return this._root.unobserve(t),this},s={},s.on=function(t,e){var r,s,o,i=this;if("object"==typeof t){o=[];for(s in t)t.hasOwnProperty(s)&&(o[o.length]=this.on(s,t[s]));return{cancel:function(){for(;o.length;)o.pop().cancel()}}}return this._subs[t]||(this._subs[t]=[]),r=this._subs[t],r[r.length]=e,{cancel:function(){i.off(t,e)}}},s.once=function(t,e){var r,s,o,i,n=this;if("object"==typeof t){o=[];for(s in t)t.hasOwnProperty(s)&&(o[o.length]=this.once(s,t[s]));return{cancel:function(){for(;o.length;)o.pop().cancel()}}}return this._subs[t]||(this._subs[t]=[]),r=this._subs[t],i=function(){e.apply(n,arguments),n.off(t,i)},r[r.length]=i,{cancel:function(){n.off(t,i)}}},s.off=function(t,e){var r,s;return t?e?(r=this._subs[t],r&&(s=r.indexOf(e),-1!==s&&r.splice(s,1),r.length||delete this._subs[t]),this):(delete this._subs[t],this):(this._subs={},this)},s.fire=function(t){var e,r,s,o;if(e=this._subs[t],!e)return this;for(s=e.length,r=Array.prototype.slice.call(arguments,1),o=0;s>o;o+=1)e[o].apply(this,r)},n=function(t,e){return null===t&&null===e?!0:"object"==typeof t||"object"==typeof e?!1:t===e},a=function(t){return v[t]||(v[t]=t.replace(/\[\s*([0-9]+)\s*\]/g,".$1"))},h=function(t,e){var r,s,o,i,n;for(r=t._observers[e],i=e.split(".");i.length;)for(i.pop(),e=i.join("."),s=t._observers[e],n=s.length;n--;)o=s[n],o.observedKeypath===e&&(r[r.length]=o);return t._rootObservers&&(r=r.concat(t._rootObservers)),r},u=function(t,e){var r,s;for(t._setOps=[];r--;)s=e[r]},c=function(t,e){var r;for(r in e)e.hasOwnProperty(r)&&(t[r]=e[r])},c(p,s),c(_,s),e.prototype=p,r.prototype=_,e.compile=o,e.utils=i,"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):t.Statesman=e})(this);