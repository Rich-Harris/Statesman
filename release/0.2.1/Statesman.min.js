(function(t){"use strict";var e,s,n,i,o,r,h,a,u,c,f,p,l,d,g,v,y,b,m,w,O={},x={},j={};try{Object.defineProperty({},"test",{value:0}),Object.defineProperties({},{test:{value:0}}),m=Object.defineProperty,w=Object.defineProperties}catch(P){m=function(t,e,s){t[e]=s.value},w=function(t,e){var s;for(s in e)e.hasOwnProperty(s)&&m(t,s,e[s])}}e=function(t){w(this,{data:{value:t||{},writable:!0},subs:{value:{},writable:!0},cache:{value:{}},cacheMap:{value:{}},deps:{value:{}},depsMap:{value:{}},refs:{value:{}},refsMap:{value:{}},computed:{value:{}},subsets:{value:{}},deferred:{value:[]},changes:{value:null,writable:!0},upstreamChanges:{value:null,writable:!0},changeHash:{value:null,writable:!0}})},O.add=function(t,e){var s=this.get(t);void 0===e&&(e=1),h(s)&&h(e)&&this.set(t,+s+(void 0===e?1:+e))},function(t){var e,s,n,o,h;t.compute=function(t,s){var n,i,o;if("object"==typeof t){n={};for(i in t)t.hasOwnProperty(i)&&(o=new e(this,i,t[i]),n[i]=o.value);return n}return o=new e(this,t,s),o.value},e=function(t,e,o){var r;if(t.computed[e]&&t.computed[e].teardown(),this.statesman=t,this.keypath=e,t.computed[e]=this,"string"==typeof o?o=i(o,t):("function"==typeof o&&(o=o()),n(e,o,t.debug)),this.signature=o,this.cache=o.cache,this.async=o.async,this.context=o.context||t,this.refs=[],r=o.dependsOn.length,this.cache)for(1===r&&(this.selfUpdating=!0);r--;)this.refs[r]=new s(this,o.dependsOn[r]);this.setting=!0,t.set(this.keypath,this.value=this.getter()),this.setting=!1},e.prototype={bubble:function(){this.selfUpdating?this.update():this.deferred||(this.statesman.deferred.push(this),this.deferred=!0)},update:function(){var t;return t=this.getter(),r(t,this.value)||(this.setting=!0,c(this.statesman,this.keypath,t),this.setting=!1,this.value=t),this},getter:function(){var t,e,s,n,i,o,r=this;n=this.statesman;try{if(this.signature.compiled)s=this.signature.compiled();else{if(e=[],this.async&&(i=this.context.async,this.context.async=function(){return function(t){o?(r.setting=!0,n.set(r.keypath,t),r.setting=!1):(wasSynchronous=!0,synchronousResult=t)}}),this.cache){for(t=this.refs.length;t--;)e[t]=this.refs[t].value;s=this.signature.get.apply(this.context,e)}else{for(t=this.signature.dependsOn.length;t--;)e[t]=n.get(this.signature.dependsOn[t]);s=this.signature.get.apply(this.context,e)}o=!0,this.async&&(this.context.async=i,wasSynchronous?s=synchronousResult:void 0===s&&(s=this.value))}}catch(h){if(n.debug)throw h;s=void 0}return this.override=!1,s},setter:function(t){if(this.signature.set)try{this.signature.set.call(this.context,t)}catch(e){if(this.statesman.debug)throw e}else if(this.signature.readonly){if(this.statesman.debug)throw Error('You cannot overwrite a computed value ("'+this.keypath+'"), unless its readonly flag is set true')}else this.override=!0,this.setting=!0,this.statesman.set(this.keypath,t),this.setting=!1},teardown:function(){for(;this.refs.length;)this.refs.pop().teardown(),this.statesman.computed[this.keypath]=null}},s=function(t,e){this.computed=t,this.statesman=t.statesman,this.keypath=e,this.value=this.statesman.get(e),y(this,!0)},s.prototype={update:function(){var t;t=this.statesman.get(this.keypath),r(t,this.value)||(this.value=t,this.computed.bubble())},teardown:function(){b(this,!0)}},o=[],h=/async/,n=function(t,e,s){if(!e.compiled){if(!e.get&&!e.set)throw Error("Computed values must have either a get() or a set() method, or both");if(e.set||e.readonly===!1||(e.readonly=!0),e.dependsOn?"string"==typeof e.dependsOn&&(e.dependsOn=[e.dependsOn]):e.dependsOn=o,!e.dependsOn.length){if(e.cache&&s)throw Error("Computed values with no dependencies must be uncached");e.cache=!1}e.cache!==!1&&(e.cache=!0),e.get&&h.test(e.get)&&(e.async=!0)}if(-1!==e.dependsOn.indexOf(t))throw Error('A computed value ("'+t+'") cannot depend on itself');return e}}(O),O.get=function(t){return f(this,t&&a(t))};var f=function(t,e,s,n){var i,o,r,h,a;return e?((i=t.computed[e])&&(n||i.cache||i.override||(t.cache[e]=i.getter())),t.cache.hasOwnProperty(e)?t.cache[e]:(s=s||e.split("."),o=s.pop(),r=s.join("."),h=f(t,r,s),"object"==typeof h&&h.hasOwnProperty(o)&&(a=h[o],t.cache[e]=a,t.cacheMap[r]||(t.cacheMap[r]=[]),t.cacheMap[r].push(e)),a)):t.data};(function(t){var e;t.observe=function(t,s,n){var i,o,r,h,a;if(a=!n||n.init!==!1,"function"==typeof t&&(n=s,s=t,t=""),"string"==typeof t)return i=new e(this,t,s,n),a?i.update():i.value=this.get(t),{cancel:function(){i.teardown()}};if("object"!=typeof t)throw Error("Bad arguments to Statesman.prototype.observe()");n=s,o=[];for(r in t)t.hasOwnProperty(r)&&(o[o.length]=new e(this,r,t[r],n));if(h=o.length,a)for(;h--;)o[h].update();else for(;h--;)o[h].value=this.get(i.keypath);return{cancel:function(){for(h=o.length;h--;)o[h].teardown()}}},e=function(t,e,s,n){this.statesman=t,this.keypath=a(e),this.callback=s,this.context=n&&n.context?n.context:t,y(this)},e.prototype={update:function(){var t;if(t=f(this.statesman,this.keypath),!r(t,this.value)){try{this.callback.call(this.context,t,this.value)}catch(e){if(this.statesman.debug)throw e}this.value=t}},teardown:function(){b(this)}}})(O),O.removeComputedValue=function(t){return this.computed[t]&&this.computed[t].teardown(),this},O.reset=function(t){return this.data={},this.set(t,{silent:!0}),this.fire("reset"),l(this,""),this},function(t){var e,s,n=/^\s*[0-9]+\s*$/;t.set=function(t,e,n){var i,o,r,h;if(this.changes=[],this.upstreamChanges=[],this.changeHash={},"object"==typeof t){n=e;for(r in t)t.hasOwnProperty(r)&&(h=a(r),e=t[r],c(this,h,e))}else h=a(t),c(this,h,e);for(i=[],o=[];this.changes.length;)s(i,this.changes),s(o,this.upstreamChanges),g(this);return n&&n.silent?this:(d(this,o,!0),i.length&&d(this,i),i.length&&this.fire("change",this.changeHash),this)},c=function(t,s,n){var i,o,r;if((r=t.computed[s])&&!r.setting)return r.setter(n),void 0;if(i=f(t,s,null,!0),i!==n)e(t.data,s,n);else if("object"!=typeof n)return;for(p(t,s),t.changes[t.changes.length]=s,t.changeHash[s]=n,o=s.split(".");o.length&&(o.pop(),s=o.join("."),!t.upstreamChanges[s]);)t.upstreamChanges[s]=!0,t.upstreamChanges.push(s)},e=function(t,e,s){for(var i,o=e.split(".");o.length>1;)i=o.shift(),t[i]||(t[i]=n.test(o[0])?[]:{}),t=t[i];t[o[0]]=s},s=function(t,e){for(var s,n=e.length;n--;)s=e[n],t["_"+s]||(t["_"+s]=!0,t[t.length]=s)}}(O),O.subset=function(t){if(!t)throw"No subset path specified";return this.subsets[t]||(this.subsets[t]=new s(t,this)),this.subsets[t]},O.subtract=function(t,e){var s=this.get(t);void 0===e&&(e=1),h(s)&&h(e)&&this.set(t,+s-(void 0===e?1:+e))},O.toggle=function(t){this.set(t,!this.get(t))},p=function(t,e){var s=t.cacheMap[e];if(delete t.cache[e],s)for(;s.length;)p(t,s.pop())},h=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},l=function(t,e,s){var n,i,o;if(n=t.deps[e])for(i=n.length;i--;)n[i].update();if(!s&&(o=t.depsMap[e]))for(i=o.length;i--;)l(t,o[i])},d=function(t,e,s){var n;for(n=e.length;n--;)l(t,e[n],s)},g=function(t){var e,s,n,i,o;for(s=t.changes,n=t.upstreamChanges,t.changes=[],t.upstreamChanges=[],e=n.length;e--;)i=n[e],v(t,i,!0);for(e=s.length;e--;)i=s[e],v(t,i);for(;t.deferred.length;)o=t.deferred.pop(),o.update(),o.deferred=!1},v=function(t,e,s){var n,i,o;if(n=t.refs[e])for(o=n.length;o--;)n[o].update();if(!s&&(i=t.refsMap[e]))for(o=i.length;o--;)v(t,i[o])},y=function(t,e){var s,n,i,o,r,h,a,u;for(s=t.statesman,n=t.keypath,e?(a=s.refs,u=s.refsMap):(a=s.deps,u=s.depsMap),i=a[n]||(a[n]=[]),i[i.length]=t,o=n.split(".");o.length;)o.pop(),r=o.join("."),h=u[r]||(u[r]=[]),void 0===h[n]&&(h[n]=0,h[h.length]=n),h[n]+=1,n=r},b=function(t,e){var s,n,i,o,r,h,a,u;for(s=t.statesman,n=t.keypath,e?(a=s.refs,u=s.refsMap):(a=s.deps,u=s.depsMap),i=a[n],i.splice(i.indexOf(t),1),o=n.split(".");o.length;)o.pop(),r=o.join("."),h=u[r],h[n]-=1,h[n]||(h.splice(h.indexOf(n),1),h[n]=void 0),n=r},o={total:function(t){return t.reduce(function(t,e){return t+e})}},s=function(t,e){var s,n,i=this;this.path=t,this.pathDot=t+".",this.root=e,this.subs={},s=RegExp("^"+this.pathDot.replace(".","\\.")),n=this.pathDot.length,this.root.on("change",function(t){var e,o,r,h;r={};for(o in t)t.hasOwnProperty(o)&&s.test(o)&&(e=o.substring(n),r[e]=t[o],h=!0);h&&i.fire("change",r)})},x.add=function(t,e){this.root.add(this.pathDot+t,e)},function(t){var e;t.compute=function(t,s){var n,i;if("object"==typeof t){n={};for(i in t)t.hasOwnProperty(i)&&(n[i]=e(this,i,t));return n}return e(this,t,s)},e=function(t,e,s){var n,o=t.pathDot;if("string"==typeof s)return s=i(s,t.root,o),t.root.compute(o+e,s);if("function"==typeof s&&(s=s()),s.dependsOn)for("string"==typeof s.dependsOn&&(s.dependsOn=[s.dependsOn]),n=s.dependsOn.length;n--;)s.dependsOn=o+s.dependsOn;return s.context||(s.context=t),t.root.compute(o+e,s)}}(x),x.get=function(t){return t?this.root.get(this.pathDot+t):this.root.get(this.path)},x.observe=function(t,e,s){var n,i;if("object"==typeof t){s=e,i={};for(n in t)t.hasOwnProperty(n)&&(i[this.pathDot+n]=t[n]);return s?s.context=s.context||this:s={context:this},this.root.observe(i,s)}return"function"==typeof t?(s=e,e=t,t=this.path):t=""===t?this.path:this.pathDot+t,s?s.context=s.context||this:s={context:this},this.root.observe(t,e,s)},x.removeComputedValue=function(t){return this.root.removeComputedValue(this.pathDot+t),this},x.reset=function(t){return this.root.set(this.path,t),this},x.set=function(t,e,s){var n,i;if("object"==typeof t){s=e,i={};for(n in t)t.hasOwnProperty(n)&&(i[this.pathDot+n]=t[n]);return this.root.set(i,s),this}return this.root.set(this.pathDot+t,e,s),this},x.subset=function(t){return this.root.subset(this.pathDot+t)},x.subtract=function(t,e){this.root.subtract(this.pathDot+t,e)},x.toggle=function(t){this.root.toggle(this.pathDot+t)},n={},n.on=function(t,e){var s,n,i,o=this;if("object"==typeof t){i=[];for(n in t)t.hasOwnProperty(n)&&(i[i.length]=this.on(n,t[n]));return{cancel:function(){for(;i.length;)i.pop().cancel()}}}return this.subs[t]||(this.subs[t]=[]),s=this.subs[t],s[s.length]=e,{cancel:function(){o.off(t,e)}}},n.once=function(t,e){var s,n,i,o,r=this;if("object"==typeof t){i=[];for(n in t)t.hasOwnProperty(n)&&(i[i.length]=this.once(n,t[n]));return{cancel:function(){for(;i.length;)i.pop().cancel()}}}return this.subs[t]||(this.subs[t]=[]),s=this.subs[t],o=function(){e.apply(r,arguments),r.off(t,o)},s[s.length]=o,{cancel:function(){r.off(t,o)}}},n.off=function(t,e){var s,n;return t?e?(s=this.subs[t],s&&(n=s.indexOf(e),-1!==n&&s.splice(n,1),s.length||delete this.subs[t]),this):(delete this.subs[t],this):(this.subs={},this)},n.fire=function(t){var e,s,n,i;if(e=this.subs[t],!e)return this;for(n=e.length,s=Array.prototype.slice.call(arguments,1),i=0;n>i;i+=1)e[i].apply(this,s)},function(){var t=/\$\{\s*([a-zA-Z0-9_$\[\]\.]+)\s*\}/g;i=function(s,n,i){var o,r,h,a;return i=i||"",r=[],o=s.replace(t,function(t,e){return-1===r.indexOf(e)&&(r[r.length]=i+e),'m.get("'+i+e+'")'}),h=Function("utils","var m=this;return "+o),a=h.bind?h.bind(n,e.utils):function(){return h.call(n,e.utils)},{compiled:a,dependsOn:r,cache:!!r.length}}}(),r=function(t,e){return null===t&&null===e?!0:"object"==typeof t||"object"==typeof e?!1:t===e},a=function(t){return j[t]||(j[t]=t.replace(/\[\s*([0-9]+)\s*\]/g,".$1"))},u=function(t,e){var s;for(s in e)e.hasOwnProperty(s)&&(t[s]=e[s])},u(O,n),u(x,n),e.prototype=O,s.prototype=x,e.utils=o,"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):t.Statesman=e})(this);